"""Green agent implementation - manages assessment and evaluation."""

import sys
import uvicorn
import tomllib
import dotenv
import json
import time
from a2a.server.apps import A2AStarletteApplication
from a2a.server.request_handlers import DefaultRequestHandler
from a2a.server.agent_execution import AgentExecutor, RequestContext
from a2a.server.events import EventQueue
from a2a.server.tasks import InMemoryTaskStore
from a2a.types import AgentCard, SendMessageSuccessResponse, Message
from a2a.utils import new_agent_text_message, get_text_parts
from src.util.my_a2a import parse_tags, send_message
from pathlib import Path
from dataclasses import dataclass
from .mcp_client import MCPClient

dotenv.load_dotenv()


def load_agent_card_toml(agent_name):
    current_dir = __file__.rsplit("/", 1)[0]
    with open(f"{current_dir}/{agent_name}.toml", "rb") as f:
        return tomllib.load(f)

def read_from_jsonl(file_path):
    data = []
    with open(file_path, 'r', encoding='utf-8') as file:
        for line in file:
            data.append(json.loads(line.strip()))
    return data

async def benchmark_code_generation_agents(white_agent_url, mcp_client, max_num_steps=1):
    # This Green agent distributes test tasks to participant agetns and collects their response.
    # No environment interaction or multiple steps for now.
    data_file_path = Path("./data/problems_test.jsonl")
    test_data = read_from_jsonl(data_file_path)

    for data in test_data:
        pname = data["problem_name"]
        pid = data["problem_id"]
        pdesc = data["problem_description"]

        print(
            f"@@@ Green agent: Sending message to white agent... -->\n{pdesc}"
        )
        white_agent_response = await send_message(
            white_agent_url, pdesc, context_id=pname,
        )
        res_root = white_agent_response.root
        assert isinstance(res_root, SendMessageSuccessResponse)
        res_result = res_root.result
        assert isinstance(
            res_result, Message
        )  # though, a robust design should also support Task

        print(
            f"@@@ Green agent: Compile and run the code generated by white agent..."
        )
        text_parts = get_text_parts(res_result.parts)
        assert len(text_parts) == 1, (
            "Expecting exactly one text part from the white agent"
        )
        white_text = text_parts[0]
        print(f"@@@ White agent response:\n{white_text}")
        lines = white_text.strip().splitlines()
        file_path = lines[1].strip()
        cli_args = lines[2].strip()
        await mcp_client.run_bash_command("upload_file", file_path)
        await mcp_client.run_bash_command("make", pname)
        result = await mcp_client.run_bash_command(f"./{pname}", cli_args)
        print(result.content[0].text) # use LLM as a judge
        # parse the action out
        if result.isError:
            success = 0
        else:
            success = 1
        # success = parse_tags(white_text)
    return {"success": success}


class GreenAgentExecutor(AgentExecutor):
    def __init__(self):
        self.client = MCPClient()

    async def execute(self, context: RequestContext, event_queue: EventQueue) -> None:
        # parse the task
        print("Green agent: Received a task, parsing...")
        user_input = context.get_user_input()
        tags = parse_tags(user_input)
        white_agent_url = tags["white_agent_url"]

        metrics = {}

        print("Green agent: Connecting to MCP servers...")
        try:
            await self.client.connect_to_local_server("./tools/petsc_mcp_servers/petsc_compile_run_mcp_server.py")
            #await self.client.connect_to_remote_server(sys.argv[1])
            print("Green agent: Starting code generation request...")
            timestamp_started = time.time()
            res = await benchmark_code_generation_agents(white_agent_url, self.client)
        finally:
            await self.client.cleanup()

        metrics["time_used"] = time.time() - timestamp_started
        # For now, we just indicate success of getting a response
        metrics["success"] = bool(res.get("success"))
        result_emoji = "✅" if metrics["success"] else "❌"

        print("Green agent: Code generation request complete.")
        await event_queue.enqueue_event(
            new_agent_text_message(
                f"Finished. White agent code generated: {result_emoji}\nMetrics: {metrics}\n" 
                # f"Generated Code:\n```python\n{res.get('generated_code', 'No code generated.')}\n```\n"
            )
        )

    async def cancel(self, context: RequestContext, event_queue: EventQueue) -> None:
        raise NotImplementedError


def start_green_agent(agent_name="green_agent", host="localhost", port=9001):
    print("Starting green agent...")
    agent_card_dict = load_agent_card_toml(agent_name)
    url = f"http://{host}:{port}"
    agent_card_dict["url"] = url  # complete all required card fields

    request_handler = DefaultRequestHandler(
        agent_executor=GreenAgentExecutor(),
        task_store=InMemoryTaskStore(),
    )

    app = A2AStarletteApplication(
        agent_card=AgentCard(**agent_card_dict),
        http_handler=request_handler,
    )

    uvicorn.run(app.build(), host=host, port=port)
